<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reseñas — Openmium</title>
  <meta name="description" content="Reseñas de productos, libros y más. Filtrado y galería." />
  <link rel="stylesheet" href="styles.css">
  <style>
    /* --- Fondo difuminado que cubre toda la página --- */
    html,body { height:100%; margin:0; }
    body {
      background:
        radial-gradient(circle at 10% 15%, rgba(11,116,222,0.03), transparent 8%),
        radial-gradient(circle at 90% 85%, rgba(59,130,246,0.02), transparent 10%),
        linear-gradient(180deg, #eef6fb 0%, #e1e9f4 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      color:var(--text);
    }
    .container { background: transparent; }

    /* layout / lista */
    .list { display:flex; flex-direction:column; gap:14px; margin-top:10px; }

    /* tarjeta: borde claro, sombra difusa y separación */
    .review-card {
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:14px;
      border-radius:10px;
      border:1px solid rgba(2,6,23,0.06);    /* borde muy sutil */
      background:#ffffff;
      box-shadow: 0 6px 20px rgba(2,6,23,0.035); /* sombra ligera y difusa */
      cursor:pointer;
      transition: transform .14s cubic-bezier(.2,.8,.2,1), box-shadow .14s ease, border-color .14s ease;
      margin-bottom:2px;
    }
    .review-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 20px 40px rgba(2,6,23,0.07);
      border-color: rgba(11,116,222,0.12);
    }
    .review-card:focus { outline: 3px solid rgba(11,116,222,0.10); outline-offset:2px; }

    /* mini separador entre tarjetas para reforzar separación */
    .list > .review-card + .review-card { margin-top:8px; }

    .review-thumb { width:140px; height:92px; flex-shrink:0; border-radius:8px; overflow:hidden; background:#f6f8fb; display:block; border:1px solid rgba(12,18,26,0.03); }
    .review-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .review-body { flex:1; display:flex; flex-direction:column; gap:8px; }
    .meta { font-size:12px; color:#6b7280; letter-spacing:0.1px; }

    /* precio y botón */
    .price { font-weight:800; color:#0b74de; margin-top:2px; }
    .product-link-btn {
      display:inline-block;
      margin-top:8px;
      padding:7px 10px;
      border-radius:8px;
      background:#0b74de;
      color:#fff;
      text-decoration:none;
      font-weight:700;
      font-size:13px;
      max-width:140px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
      box-shadow: 0 6px 18px rgba(11,116,222,0.08);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .product-link-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 30px rgba(11,116,222,0.10); }

    .product-link-btn:visited{ color:#fff; }

    /* estrellas */
    .stars { display:inline-flex; align-items:center; gap:6px; }
    .star { font-size:14px; line-height:1; }
    .star.full { color:#f5b301; }
    .star.half {
      color:transparent;
      background: linear-gradient(90deg, #f5b301 50%, #ddd 50%);
      -webkit-background-clip: text;
      background-clip: text;
      display:inline-block;
    }
    .star.empty { color:#ddd; }

    /* responsive */
    @media(max-width:720px){
      .review-card{ flex-direction:row; gap:10px; padding:10px; }
      .review-thumb{ width:110px; height:72px; }
      .product-link-btn{ max-width:120px; font-size:12px; padding:6px 8px; }
    }
  </style>
</head>
<body>
  <header class="nav">
    <div class="wrap" id="mainNav"></div>
  </header>

  <script>
    (function buildNav(){
      const navWrap = document.getElementById('mainNav');
      const pages = [
        { file: 'index.html', label: 'Sobre mí' },
        { file: 'libros.html', label: 'Libros' },
        { file: 'reviews.html', label: 'Reseñas' }
      ];
      const current = (location.pathname.split('/').pop() || 'reviews.html').toLowerCase();
      const left = document.createElement('div'); left.innerHTML = '<strong>Mi Sitio</strong>';
      const right = document.createElement('nav');
      pages.forEach(p => { if (p.file === current) return; const a = document.createElement('a'); a.href = p.file; a.textContent = p.label; a.style.marginLeft = '12px'; right.appendChild(a); });
      navWrap.appendChild(left); navWrap.appendChild(right);
    })();
  </script>

  <main class="container">
    <h1>Reseñas</h1>

    <section class="card" style="margin-bottom:12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="searchBox" placeholder="Buscar por título, tag..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8">
        <select id="categorySelect" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
          <option value="all">Todas las categorías</option>
        </select>
        <select id="subSelect" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
          <option value="all">Todas las subcategorías</option>
        </select>
        <input id="dateFilter" type="date" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
        <button id="clearFilters" class="btn" style="background:#fff;border:1px solid #e6eef8">Limpiar</button>
      </div>
    </section>

    <section id="reviewsList" class="list" aria-live="polite"></section>

    <footer class="footer">© 2025 [Tu Nombre]</footer>
  </main>

  <!-- modal detalle con galería -->
  <div id="detailModal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-card">
      <button id="closeDetail" class="modal-close" aria-label="Cerrar">✕</button>
      <div id="detailContent"></div>
    </div>
  </div>

  <script>
    const DATA_PATH = 'data/reviews.json';
    let REVIEWS = [];
    let CATEGORIES = [];

    function formatDateToDDMMYYYY(raw){
      if(!raw) return '';
      if(/^\d{2}-\d{2}-\d{4}$/.test(raw)) return raw;
      if(/^\d{4}-\d{2}-\d{2}$/.test(raw)){
        const [y,m,d] = raw.split('-'); return `${d}-${m}-${y}`;
      }
      const date = new Date(raw);
      if(!isNaN(date)) {
        const d = String(date.getDate()).padStart(2,'0');
        const m = String(date.getMonth()+1).padStart(2,'0');
        const y = date.getFullYear();
        return `${d}-${m}-${y}`;
      }
      return raw;
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function renderStars(rating){
      if(rating == null) return '';
      const full = Math.floor(rating);
      const half = (rating - full) >= 0.5 ? 1 : 0;
      const empty = 5 - full - half;
      let out = '<span class="stars" aria-hidden="true">';
      for(let i=0;i<full;i++) out += '<span class="star full">★</span>';
      if(half) out += '<span class="star half">★</span>';
      for(let i=0;i<empty;i++) out += '<span class="star empty">★</span>';
      out += `</span> <span style="font-size:13px;color:var(--muted);margin-left:6px">(${rating}/5)</span>`;
      return out;
    }

    async function loadData(){
      try{
        const res = await fetch(DATA_PATH, {cache: "no-store"});
        if(!res.ok) throw new Error('No se pudo cargar ' + DATA_PATH + ' — status ' + res.status);
        const json = await res.json();
        REVIEWS = json.reviews || [];
        CATEGORIES = json.categories || [];
      } catch(err){
        console.error('[loadData] ', err);
        REVIEWS = [];
        CATEGORIES = [];
        document.getElementById('reviewsList').innerHTML = `<div class="card">Error cargando datos: revisa la consola (F12). ${escapeHtml(err.message||'')}</div>`;
      }
      populateCategoryFilters();
      renderList(REVIEWS);
    }

    function populateCategoryFilters(){
      const catSelect = document.getElementById('categorySelect');
      catSelect.innerHTML = '<option value="all">Todas las categorías</option>';
      CATEGORIES.forEach(c => {
        const o = document.createElement('option'); o.value = c.id; o.textContent = c.label; catSelect.appendChild(o);
      });
    }

    function populateSubSelect(catId){
      const subSel = document.getElementById('subSelect');
      subSel.innerHTML = '<option value="all">Todas las subcategorías</option>';
      if(catId && catId !== 'all'){
        const cat = CATEGORIES.find(c => c.id === catId);
        if(cat && Array.isArray(cat.subs)){
          cat.subs.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; subSel.appendChild(o); });
        }
      }
    }

    function renderList(list){
      const el = document.getElementById('reviewsList'); el.innerHTML = '';
      if(!list.length){ el.innerHTML = '<div class="card">No hay reseñas.</div>'; return; }
      list.forEach(r => {
        const dateStr = formatDateToDDMMYYYY(r.date || '');
        const thumb = (r.images && r.images[0]) ? r.images[0] : 'assets/covers/placeholder.jpg';
        const priceHtml = r.price ? `<div class="price">${escapeHtml(r.price)}</div>` : '';
        const starsHtml = r.rating ? renderStars(r.rating) : '';
        const card = document.createElement('article');
        card.className = 'review-card';
        card.tabIndex = 0;
        card.innerHTML = `
          <div class="review-thumb"><img src="${thumb}" alt=""></div>
          <div class="review-body">
            <div class="meta">${escapeHtml(dateStr)} · ${escapeHtml(r.category||'')} › ${escapeHtml(r.sub||'')}</div>
            <h3>${escapeHtml(r.title)}</h3>
            <p class="note">${escapeHtml(r.summary || '')}</p>
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
              ${starsHtml}
              ${priceHtml}
            </div>
            ${ r.link ? `<a class="product-link-btn" href="${r.link}" target="_blank" rel="noopener">Ver producto</a>` : '' }
          </div>
        `;
        card.addEventListener('click', ()=> openDetail(r.id));
        card.addEventListener('keydown', (e)=> { if(e.key === 'Enter' || e.key === ' ') openDetail(r.id); });
        el.appendChild(card);
      });
    }

    function openDetail(id){
      const item = REVIEWS.find(x => x.id === id); if(!item) return;
      const imgs = (item.images || []).slice(0,8);
      let galleryHtml = '';
      if(imgs.length){
        galleryHtml += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:flex-start">';
        galleryHtml += `<div id="mainImg" style="flex:1;min-width:220px"><img src="${imgs[0]}" style="width:100%;height:auto;max-height:420px;object-fit:cover;border-radius:6px"></div>`;
        galleryHtml += '<div style="display:flex;flex-direction:column;gap:8px;min-width:110px">';
        imgs.forEach((u)=>{ galleryHtml += `<img class="thumb" src="${u}" data-src="${u}" style="width:100px;height:70px;object-fit:cover;border-radius:4px;cursor:pointer">`; });
        galleryHtml += '</div></div>';
      }
      const dateStr = formatDateToDDMMYYYY(item.date || '');
      const starsHtml = item.rating ? renderStars(item.rating) : '';
      const priceHtml = item.price ? `<div class="price">${escapeHtml(item.price)}</div>` : '';
      const linkHtml = item.link ? `<div style="margin-top:12px"><a class="btn btn-primary" href="${item.link}" target="_blank" rel="noopener">Ver producto</a></div>` : '';
      document.getElementById('detailContent').innerHTML = `${galleryHtml}
        <div class="meta">${escapeHtml(dateStr)} · ${escapeHtml(item.category||'')} / ${escapeHtml(item.sub||'')}</div>
        <h2 style="margin:8px 0">${escapeHtml(item.title)}</h2>
        ${starsHtml}
        ${priceHtml}
        <p class="note" style="margin-top:8px">${escapeHtml(item.content || item.summary || '')}</p>
        ${linkHtml}
      `;
      setTimeout(()=>{
        document.querySelectorAll('#detailContent .thumb').forEach(t => t.addEventListener('click', (e)=>{
          const src = e.currentTarget.dataset.src;
          const main = document.getElementById('mainImg');
          if(main) main.querySelector('img').src = src;
        }));
      }, 20);
      const modal = document.getElementById('detailModal'); modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
    }

    document.getElementById('closeDetail').addEventListener('click', ()=> {
      const modal = document.getElementById('detailModal'); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
    });

    // filtros y controles
    document.getElementById('searchBox').addEventListener('input', applyFilters);
    document.getElementById('categorySelect').addEventListener('change', (e)=> {
      const cat = e.currentTarget.value;
      populateSubSelect(cat);
      applyFilters();
    });
    document.getElementById('subSelect').addEventListener('change', applyFilters);
    document.getElementById('dateFilter').addEventListener('change', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', ()=> {
      document.getElementById('searchBox').value = '';
      document.getElementById('categorySelect').value = 'all';
      document.getElementById('subSelect').innerHTML = '<option value="all">Todas las subcategorías</option>';
      document.getElementById('dateFilter').value = '';
      renderList(REVIEWS);
    });

    function applyFilters(){
      const q = document.getElementById('searchBox').value.trim().toLowerCase();
      const cat = document.getElementById('categorySelect').value;
      const sub = document.getElementById('subSelect').value;
      const date = document.getElementById('dateFilter').value;
      let filtered = REVIEWS.slice();
      if(cat && cat !== 'all') filtered = filtered.filter(r => r.category === cat);
      if(sub && sub !== 'all') filtered = filtered.filter(r => r.sub === sub);
      if(q) filtered = filtered.filter(r => (r.title + ' ' + (r.summary||'') + ' ' + (r.tags||[]).join(' ')).toLowerCase().includes(q));
      if(date){
        const target = formatDateToDDMMYYYY(date);
        filtered = filtered.filter(r => {
          const rd = formatDateToDDMMYYYY(r.date || '');
          return rd === target;
        });
      }
      renderList(filtered);
    }

    // init
    loadData();
  </script>
</body>
</html>
