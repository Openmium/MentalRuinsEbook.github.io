<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reseñas — Mi Sitio</title>
  <meta name="description" content="Reseñas de productos, libros y más. Filtrado por categoría, sub y fecha.">
  <link rel="stylesheet" href="styles.css">
  <style>
    .stars {
      color: gold;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <header class="nav">
    <div class="wrap" id="mainNav"></div>
  </header>

  <script>
    (function buildNav(){
      const navWrap = document.getElementById('mainNav');
      const pages = [
        { file: 'index.html', label: 'Sobre mí' },
        { file: 'libros.html', label: 'Libros' },
        { file: 'reviews.html', label: 'Reseñas' }
      ];
      const current = (location.pathname.split('/').pop() || 'reviews.html').toLowerCase();
      const left = document.createElement('div'); left.innerHTML = '<strong>Mi Sitio</strong>';
      const right = document.createElement('nav');
      pages.forEach(p => { if (p.file === current) return; const a = document.createElement('a'); a.href = p.file; a.textContent = p.label; a.style.marginLeft = '12px'; right.appendChild(a); });
      navWrap.appendChild(left); navWrap.appendChild(right);
    })();
  </script>

  <main class="container">
    <h1>Reseñas</h1>

    <section class="card" style="margin-bottom:12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="searchBox" placeholder="Buscar por título, tag..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8">
        <select id="categorySelect" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
          <option value="all">Todas las categorías</option>
        </select>
        <select id="subSelect" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
          <option value="all">Todas las subcategorías</option>
        </select>
        <input id="dateFilter" type="date" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
        <button id="clearFilters" class="btn" style="background:#fff;border:1px solid #e6eef8">Limpiar</button>
      </div>
    </section>

    <section class="list" id="reviewsList"></section>

    <footer class="footer">© 2025 [Tu Nombre]</footer>
  </main>

  <!-- modal detalle con galería -->
  <div id="detailModal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-card">
      <button id="closeDetail" class="modal-close" aria-label="Cerrar">✕</button>
      <div id="detailContent"></div>
    </div>
  </div>

  <script>
    const KEY_REV = 'data/reviews.json';
    let REVIEWS = [];

    async function loadReviews(){
      try {
        const res = await fetch('data/reviews.json', { cache: "no-store" });
        if(!res.ok) throw new Error('No se pudo cargar data/reviews.json — status ' + res.status);
        const json = await res.json();
        REVIEWS = json.reviews || [];
      } catch(err){
        console.error('[loadReviews] Error cargando reviews.json:', err);
        REVIEWS = [];
        const container = document.getElementById('reviewsList');
        if(container){
          container.innerHTML = `<div class="card">Error cargando reseñas: revisa la consola (F12). (${escapeHtml(err.message || '')})</div>`;
        }
      }
      populateCategoryFilters();
      renderList(REVIEWS);
    }

    function populateCategoryFilters(){
      const cats = Array.from(new Set(REVIEWS.map(r => r.category))).filter(Boolean);
      const catSel = document.getElementById('categorySelect');
      catSel.innerHTML = '<option value="all">Todas las categorías</option>';
      cats.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c.charAt(0).toUpperCase()+c.slice(1); catSel.appendChild(o); });
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function renderStars(rating){
      const full = '★'.repeat(Math.floor(rating));
      const half = (rating % 1 >= 0.5) ? '½' : '';
      const empty = '☆'.repeat(5 - Math.ceil(rating));
      return `<span class="stars">${full}${half}${empty}</span>`;
    }

    function renderList(list){
      const el = document.getElementById('reviewsList'); el.innerHTML = '';
      if(!list.length){ el.innerHTML = '<div class="card">No hay reseñas.</div>'; return; }
      list.forEach(r => {
        const d = document.createElement('div'); d.className = 'card review-card'; d.tabIndex = 0;
        const thumb = (r.images && r.images[0]) ? r.images[0] : 'assets/covers/placeholder.jpg';
        d.innerHTML = `
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="width:120px;height:80px;flex-shrink:0;overflow:hidden;border-radius:6px">
              <img src="${thumb}" style="width:100%;height:100%;object-fit:cover" alt="">
            </div>
            <div style="flex:1">
              <div class="meta">${r.date} · ${r.category} › ${r.sub}</div>
              <h3>${escapeHtml(r.title)}</h3>
              <p class="note">${escapeHtml(r.summary || '')}</p>
              ${renderStars(r.rating || 0)} ${r.price ? `<p><strong>${r.price}</strong></p>` : ''}
            </div>
          </div>`;
        d.addEventListener('click', ()=> openDetail(r.id));
        d.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') openDetail(r.id); });
        el.appendChild(d);
      });
    }

    function openDetail(id){
      const item = REVIEWS.find(x => x.id === id); if(!item) return;
      const imgs = (item.images || []).slice(0,8);
      let galleryHtml = '';
      if(imgs.length){
        galleryHtml += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:flex-start">';
        galleryHtml += `<div id="mainImg" style="flex:1;min-width:220px"><img src="${imgs[0]}" style="width:100%;height:auto;max-height:420px;object-fit:cover;border-radius:6px"></div>`;
        galleryHtml += '<div style="display:flex;flex-direction:column;gap:8px;min-width:110px">';
        imgs.forEach((u)=>{ galleryHtml += `<img class="thumb" src="${u}" data-src="${u}" style="width:100px;height:70px;object-fit:cover;border-radius:4px;cursor:pointer">`; });
        galleryHtml += '</div></div>';
      }
      document.getElementById('detailContent').innerHTML = `
        ${galleryHtml}
        <div class="meta">${item.date} · ${item.category} / ${item.sub}</div>
        <h2 style="margin:8px 0">${escapeHtml(item.title)}</h2>
        ${renderStars(item.rating || 0)} ${item.price ? `<p><strong>${item.price}</strong></p>` : ''}
        <p class="note">${escapeHtml(item.content || item.summary || '')}</p>
        ${item.link ? `<p><a href="${item.link}" target="_blank" rel="noopener">Ver producto</a></p>` : ''}
      `;
      setTimeout(()=>{
        document.querySelectorAll('#detailContent .thumb').forEach(t => 
          t.addEventListener('click', (e)=>{ 
            const src = e.currentTarget.dataset.src; 
            const main = document.getElementById('mainImg'); 
            if(main) main.querySelector('img').src = src; 
          })
        );
      }, 20);
      const modal = document.getElementById('detailModal'); modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
    }

    document.getElementById('closeDetail').addEventListener('click', ()=> {
      const modal = document.getElementById('detailModal'); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
    });

    document.getElementById('searchBox').addEventListener('input', applyFilters);
    document.getElementById('categorySelect').addEventListener('change', ()=> {
      const cat = document.getElementById('categorySelect').value;
      const subs = Array.from(new Set(REVIEWS.filter(r => !cat || cat==='all' ? true : r.category === cat).map(r => r.sub))).filter(Boolean);
      const subSel = document.getElementById('subSelect');
      subSel.innerHTML = '<option value="all">Todas las subcategorías</option>';
      subs.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; subSel.appendChild(o); });
      applyFilters();
    });
    document.getElementById('subSelect').addEventListener('change', applyFilters);
    document.getElementById('dateFilter').addEventListener('change', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', ()=> { document.getElementById('searchBox').value=''; document.getElementById('categorySelect').value='all'; document.getElementById('subSelect').innerHTML='<option value="all">Todas las subcategorías</option>'; document.getElementById('dateFilter').value=''; renderList(REVIEWS); });

    function applyFilters(){
      const q = document.getElementById('searchBox').value.trim().toLowerCase();
      const cat = document.getElementById('categorySelect').value;
      const sub = document.getElementById('subSelect').value;
      const date = document.getElementById('dateFilter').value;
      let filtered = REVIEWS.slice();
      if(cat && cat !== 'all') filtered = filtered.filter(r => r.category === cat);
      if(sub && sub !== 'all') filtered = filtered.filter(r => r.sub === sub);
      if(q) filtered = filtered.filter(r => (r.title + ' ' + (r.summary||'') + ' ' + (r.tags || []).join(' ')).toLowerCase().includes(q));
      if(date) filtered = filtered.filter(r => r.date === date);
      renderList(filtered);
    }

    loadReviews();
  </script>
</body>
</html>
