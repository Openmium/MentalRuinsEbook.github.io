<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reseñas — Mi Sitio</title>
  <meta name="description" content="Reseñas de productos, libros y más. Filtrado por categoría, sub y fecha.">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="nav">
    <div class="wrap" id="mainNav"></div>
  </header>
  <script>
    (function buildNav(){
      const navWrap = document.getElementById('mainNav');
      const pages = [
        { file: 'index.html', label: 'Sobre mí' },
        { file: 'libros.html', label: 'Libros' },
        { file: 'reviews.html', label: 'Reseñas' }
      ];
      const current = (location.pathname.split('/').pop() || 'reviews.html').toLowerCase();
      const left = document.createElement('div'); left.innerHTML = '<strong>Mi Sitio</strong>';
      const right = document.createElement('nav');
      pages.forEach(p => {
        if (p.file === current) return;
        const a = document.createElement('a'); a.href = p.file; a.textContent = p.label; a.style.marginLeft = '12px';
        right.appendChild(a);
      });
      navWrap.appendChild(left); navWrap.appendChild(right);
    })();
  </script>

  <main class="container">
    <h1>Reseñas</h1>

    <section class="card" style="margin-bottom:12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="searchBox" placeholder="Buscar por título, tag..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8">
        <select id="categorySelect" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
          <option value="all">Todas las categorías</option>
        </select>
        <select id="subSelect" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
          <option value="all">Todas las subcategorías</option>
        </select>
        <input id="dateFilter" type="date" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
        <button id="clearFilters" class="btn" style="background:#fff;border:1px solid #e6eef8">Limpiar</button>
      </div>
    </section>

    <section class="list" id="reviewsList">
      <!-- reseñas renderizadas -->
    </section>

    <footer class="footer">© 2025 [Tu Nombre]</footer>
  </main>

  <!-- modal detalle -->
  <div id="detailModal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-card">
      <button id="closeDetail" class="modal-close" aria-label="Cerrar">✕</button>
      <div id="detailContent"></div>
    </div>
  </div>

  <script>
    const KEY_REV = '/data/reviews.json';
    let REVIEWS = [];

    async function loadReviews(){
      try {
        const res = await fetch(KEY_REV, {cache: "no-store"});
        if(!res.ok) throw new Error('No se pudo cargar reviews');
        const json = await res.json();
        REVIEWS = json.reviews || [];
      } catch(err){
        console.error(err);
        REVIEWS = [];
      }
      populateCategoryFilters();
      renderList(REVIEWS);
    }

    function populateCategoryFilters(){
      const cats = Array.from(new Set(REVIEWS.map(r => r.category))).filter(Boolean);
      const catSel = document.getElementById('categorySelect');
      catSel.innerHTML = '<option value="all">Todas las categorías</option>';
      cats.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = capitalize(c); catSel.appendChild(o); });
    }

    function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

    function renderList(list){
      const el = document.getElementById('reviewsList');
      el.innerHTML = '';
      if(!list.length){ el.innerHTML = '<div class="card">No hay reseñas.</div>'; return; }
      list.forEach(r => {
        const d = document.createElement('div'); d.className = 'card';
        d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div style="flex:1">
            <div class="meta">${r.date} · ${r.category} › ${r.sub}</div>
            <h3>${escapeHtml(r.title)}</h3>
            <p class="note">${escapeHtml(r.summary || '')}</p>
            <div style="margin-top:8px"><small class="note">Tags: ${(r.tags||[]).join(', ')}</small></div>
          </div>
          <div style="margin-left:8px">
            <button class="btn viewBtn" data-id="${r.id}" style="background:#fff;border:1px solid #e6eef8">Ver</button>
          </div>
        </div>`;
        el.appendChild(d);
      });
      document.querySelectorAll('.viewBtn').forEach(b => b.addEventListener('click', e => openDetail(Number(e.currentTarget.dataset.id))));
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function openDetail(id){
      const item = REVIEWS.find(x => x.id === id);
      if(!item) return;
      document.getElementById('detailContent').innerHTML = `<div class="meta">${item.date} · ${item.category} / ${item.sub}</div>
        <h2 style="margin:8px 0">${escapeHtml(item.title)}</h2>
        <p class="note">${escapeHtml(item.content || item.summary || '')}</p>`;
      const modal = document.getElementById('detailModal');
      modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
    }

    document.getElementById('closeDetail').addEventListener('click', ()=> {
      const modal = document.getElementById('detailModal');
      modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
    });

    // filtros
    document.getElementById('searchBox').addEventListener('input', applyFilters);
    document.getElementById('categorySelect').addEventListener('change', ()=> {
      const cat = document.getElementById('categorySelect').value;
      const subs = Array.from(new Set(REVIEWS.filter(r => !cat || cat==='all' ? true : r.category === cat).map(r => r.sub))).filter(Boolean);
      const subSel = document.getElementById('subSelect');
      subSel.innerHTML = '<option value="all">Todas las subcategorías</option>';
      subs.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; subSel.appendChild(o); });
      applyFilters();
    });
    document.getElementById('subSelect').addEventListener('change', applyFilters);
    document.getElementById('dateFilter').addEventListener('change', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', ()=> {
      document.getElementById('searchBox').value = ''; document.getElementById('categorySelect').value = 'all';
      document.getElementById('subSelect').innerHTML = '<option value="all">Todas las subcategorías</option>';
      document.getElementById('dateFilter').value = '';
      renderList(REVIEWS);
    });

    function applyFilters(){
      const q = document.getElementById('searchBox').value.trim().toLowerCase();
      const cat = document.getElementById('categorySelect').value;
      const sub = document.getElementById('subSelect').value;
      const date = document.getElementById('dateFilter').value;
      let filtered = REVIEWS.slice();
      if(cat && cat !== 'all') filtered = filtered.filter(r => r.category === cat);
      if(sub && sub !== 'all') filtered = filtered.filter(r => r.sub === sub);
      if(q) filtered = filtered.filter(r => (r.title + ' ' + (r.summary||'') + ' ' + (r.tags || []).join(' ')).toLowerCase().includes(q));
      if(date) filtered = filtered.filter(r => r.date === date);
      renderList(filtered);
    }

    // init
    loadReviews();
  </script>
</body>
</html>
