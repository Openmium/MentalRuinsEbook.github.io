<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Libros — Pablo Del Pozuelo Escalona</title>
  <meta name="description" content="Catálogo de libros: portada, ficha y adelanto con consentimiento.">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{
      --header-bg:#414254;
      --searchbar:#6c7792;
      --card-bg:#bcc1cd;
      --title-color:#8e9098;
      --muted:#6b6f87;
    }

    body { background: #ffffff; }

    .nav { background: var(--header-bg); color:#fff; }
    .wrap a { color: inherit; text-decoration:none; margin-left:12px; }

    .search-card {
      background: var(--searchbar);
      padding:12px;
      border-radius:12px;
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:18px;
      color:#fff;
    }
    /* make search inputs fill the available width */
    .search-card input[type="text"], .search-card select, .search-card input[type="date"] {
      padding:10px;
      border-radius:8px;
      border: none;
      background: rgba(255,255,255,0.12);
      color: #fff;
      min-width:0;
    }
    .search-card input::placeholder { color: rgba(255,255,255,0.8); }

    .books-grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap:16px;
      margin-top:10px;
    }

    .book-card {
      background: var(--card-bg);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      gap:12px;
      padding:12px;
      align-items:flex-start;
      border:1px solid rgba(0,0,0,0.06);
      transition: transform .12s ease, box-shadow .12s ease;
      cursor:pointer;
    }
    .book-card:hover{ transform: translateY(-6px); box-shadow: 0 10px 24px rgba(0,0,0,0.08); }

    .book-thumb {
      width:140px;
      height:200px;
      flex-shrink:0;
      border-radius:8px;
      overflow:hidden;
      background:#f6f6f6;
      border:1px solid rgba(0,0,0,0.04);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .book-thumb img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block; }

    .book-info { flex:1; display:flex; flex-direction:column; gap:8px; }
    .book-title { color:var(--title-color); font-size:18px; margin:0; }
    .book-sub { color:var(--muted); font-size:13px; margin:0; }
    .book-desc { color:#222; font-size:14px; margin:0; line-height:1.3; }

    .book-meta { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .book-date { font-size:13px; color:var(--muted); }
    .book-actions { margin-left:auto; display:flex; gap:8px; align-items:center; }

    .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn-primary { background:#2f3a44; color:#fff; }
    .btn-ghost { background:transparent; border:1px solid rgba(0,0,0,0.08); color:#222; }

    /* modal */
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.45); align-items:center; justify-content:center; padding:18px; z-index:120; }
    .modal.open { display:flex; }
    .modal-card { background:#fff; border-radius:12px; padding:18px; max-width:900px; width:100%; max-height:90vh; overflow:auto; position:relative; box-shadow:0 12px 36px rgba(0,0,0,0.2); }
    .modal-close { position:absolute; right:12px; top:12px; border:none; background:#f3f5f8; padding:6px 8px; border-radius:8px; cursor:pointer; z-index:2200; }

    .modal-gallery { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .modal-main-img { flex:1; min-width:240px; display:flex; align-items:center; justify-content:center; background:#fafafa; border-radius:8px; padding:8px; }
    .modal-main-img img{ width:100%; max-height:60vh; object-fit:contain; display:block; }
    .modal-thumbs { display:flex; flex-direction:column; gap:8px; min-width:110px; }
    .modal-thumbs img { width:100px; height:70px; object-fit:contain; border-radius:6px; cursor:pointer; border:1px solid rgba(0,0,0,0.06); }

    @media(max-width:880px){
      .books-grid{ grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
      .book-thumb{ width:110px; height:160px; }
      .modal-thumbs { flex-direction:row; min-width:unset; }
      .modal-thumbs img { width:72px; height:50px; }
    }
  </style>
</head>
<body>
  <header class="nav" role="banner">
    <div class="wrap" id="mainNav" role="navigation" aria-label="Principal"></div>
  </header>

  <main class="container">
    <h1 style="color:var(--title-color);margin-bottom:8px">Libros</h1>

    <section class="search-card" role="region" aria-label="Filtros de libros">
      <input id="searchInput" placeholder="Buscar por título..." type="text" aria-label="Buscar libros" style="flex:1">
      <input id="dateInput" type="date" aria-label="Filtrar por fecha">
      <button id="clearFilters" class="btn" style="background:#fff;color:#222">Limpiar</button>
    </section>

    <section id="booksSection">
      <div id="booksGrid" class="books-grid" aria-live="polite"></div>
    </section>

    <footer class="footer" style="margin-top:22px">© 2025 Pablo Del Pozuelo Escalona</footer>
  </main>

  <!-- modal(s) -->
  <div id="bookModal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-card" role="document">
      <button id="closeBookModal" class="modal-close" aria-label="Cerrar">✕</button>
      <div id="bookModalContent"></div>
    </div>
  </div>

  <script>
    // Build nav: show only other pages
    (function buildNav(){
      const navWrap = document.getElementById('mainNav');
      const pages = [
        { file: 'index.html', label: 'Sobre mí' },
        { file: 'libros.html', label: 'Libros' },
        { file: 'reviews.html', label: 'Reseñas' }
      ];
      const current = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
      const left = document.createElement('div'); left.innerHTML = '<a class="logo" href="index.html">Mi Sitio</a>';
      const right = document.createElement('nav');
      pages.forEach(p => {
        if (p.file === current) return;
        const a = document.createElement('a'); a.href = p.file; a.textContent = p.label;
        right.appendChild(a);
      });
      navWrap.appendChild(left); navWrap.appendChild(right);
    })();

    // Load books from data/books.json
    const DATA = 'data/books.json';
    let BOOKS = [];

    function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function formatDateToDDMMYYYY(raw){
      if(!raw) return '';
      if(/^\d{4}-\d{2}-\d{2}$/.test(raw)){ const [y,m,d]=raw.split('-'); return `${d}-${m}-${y}`; }
      const d = new Date(raw);
      if(!isNaN(d)){ return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`; }
      return raw;
    }

    async function loadBooks(){
      try{
        const res = await fetch(DATA, {cache:"no-store"});
        if(!res.ok) throw new Error('No se pudo cargar ' + DATA + ' status ' + res.status);
        const j = await res.json();
        BOOKS = j.books || [];
      }catch(err){
        console.error(err); BOOKS = [];
        document.getElementById('booksGrid').innerHTML = '<div class="card">Error cargando libros: revisa consola.</div>';
      }
      renderBooks(BOOKS);
    }

    function renderBooks(list){
      const grid = document.getElementById('booksGrid'); grid.innerHTML = '';
      if(!list.length){ grid.innerHTML = '<div class="card">No hay libros. Edita data/books.json</div>'; return; }
      list.forEach((b, idx) => {
        const el = document.createElement('article'); el.className = 'book-card'; el.tabIndex=0;
        el.innerHTML = `
          <div class="book-thumb"><img src="${b.cover || 'assets/covers/placeholder.jpg'}" alt="${escapeHtml(b.title)}"></div>
          <div class="book-info">
            <h3 class="book-title">${escapeHtml(b.title)}</h3>
            <div class="book-sub">${escapeHtml(b.subtitle || '')}</div>
            <p class="book-desc">${escapeHtml(b.description || '')}</p>
            <div class="book-meta">
              <div class="book-date">${b.date ? formatDateToDDMMYYYY(b.date) : ''}</div>
              <div class="book-actions">
                <a class="btn btn-primary" href="${b.amazon || '#'}" target="_blank" rel="noopener">Comprar</a>
              </div>
            </div>
          </div>
        `;
        el.addEventListener('click', ()=> openBookModal(b));
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') openBookModal(b); });
        grid.appendChild(el);
      });
    }

    // modal book detail
    const bookModal = document.getElementById('bookModal');
    const bookModalContent = document.getElementById('bookModalContent');
    document.getElementById('closeBookModal').addEventListener('click', ()=> { bookModal.classList.remove('open'); bookModal.setAttribute('aria-hidden','true'); });
    bookModal.addEventListener('click', (e)=>{ const mc = document.querySelector('.modal-card'); if(!mc.contains(e.target)){ bookModal.classList.remove('open'); bookModal.setAttribute('aria-hidden','true'); }});

    function openBookModal(book){
      bookModalContent.innerHTML = `
        <div style="display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start">
          <div style="min-width:200px"><img src="${book.cover || 'assets/covers/placeholder.jpg'}" alt="${escapeHtml(book.title)}" style="width:200px;height:300px;object-fit:contain;border-radius:8px"></div>
          <div style="flex:1">
            <h2 style="color:var(--title-color)">${escapeHtml(book.title)}</h2>
            <p class="book-sub">${escapeHtml(book.subtitle || '')} ${book.date? '· ' + formatDateToDDMMYYYY(book.date): ''}</p>
            <p style="margin-top:8px">${escapeHtml(book.description || '')}</p>
            <div style="margin-top:12px;display:flex;gap:8px">
              <a class="btn btn-primary" href="${book.amazon || '#'}" target="_blank" rel="noopener">Comprar / Ficha</a>
              ${book.sample ? `<a class="btn btn-ghost" href="${book.sample}" download>Descargar adelanto</a>` : ''}
            </div>
          </div>
        </div>
      `;
      bookModal.classList.add('open'); bookModal.setAttribute('aria-hidden','false');
    }

    // search & filters
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('dateInput').addEventListener('change', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', ()=> { document.getElementById('searchInput').value=''; document.getElementById('dateInput').value=''; renderBooks(BOOKS); });

    function applyFilters(){
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      const d = document.getElementById('dateInput').value;
      let filtered = BOOKS.slice();
      if(q) filtered = filtered.filter(b => (b.title + ' ' + (b.subtitle||'') + ' ' + (b.description||'')).toLowerCase().includes(q));
      if(d) filtered = filtered.filter(b => b.date === d);
      renderBooks(filtered);
    }

    loadBooks();
  </script>
</body>
</html>
